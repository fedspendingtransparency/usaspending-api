name: Pull Request Checks

on: push

jobs:
  Run-Linting:
    name: Run Linting
    uses: ./.github/workflows/linting.yaml
  
  Build-Broker-Docker-Image:
    name: Build Broker Docker Image
    uses: ./.github/workflows/build-broker-docker-image-for-test.yaml

  Test-Broker-Docker-Image:
    name: Test Broker Docker Image
    needs: [Build-Broker-Docker-Image]
    runs-on: ${{ vars.RUNNER_VERSION }}
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dataact-broker-backend
          path: /tmp

      - name: Load image
        run: |
          docker load --input /tmp/dataact-broker-backend.tar
          docker image ls -a
  
  Run-Spark-Integration-Load-Transaction-FABS-and-FPDS-Tests:
    name: Run Spark Integration Load Transactions FABS and FPDS Tests
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-spark-integration-load-transactions-fabs-fpds.yaml

  Run-Spark-Integration-Load-Transactions-Lookup-Tests:
    name: Run Spark Integration Load Transactions Lookup Tests
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-spark-integration-load-transactions-lookup.yaml

  Run-Spark-Integration-Load-To-From-Delta-Tests:
    name: Run Spark Integration Load To From Delta Tests
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-spark-integration-load-to-from-delta.yaml

  Run-Spark-Integration-Other-Tests:
    name: Run Spark Integration Other Tests
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-spark-integration-other.yaml

  Run-Non-Spark-Integration-Tests:
    name: Run Non-Spark Integration Tests
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-non-spark-integration.yaml

  Run-Non-Spark-Integration-Tests-Using-Signal-Handling:
    name: Run Non-Spark Integration Tests Using Signal Handling
    needs: [Run-Linting, Test-Broker-Docker-Image]
    uses: ./.github/workflows/test-non-spark-integration-using-signal-handling.yaml

  Run-Unit-Tests:
    name: Run Unit Tests
    needs: [Run-Linting]
    uses: ./.github/workflows/test-unit.yaml
