{
  "final_name": "mv_agency_office_autocomplete",
  "refresh": true,
  "matview_sql": [
    "with ",
    "awarding_agencies as ( ",
    "    select distinct awarding_agency_id ",
    "    from award_search ",
    "    where awarding_agency_id is not null ",
    "    and certified_date >= '2007-10-01'::date ",
    "), ",
    "funding_agencies as ( ",
    "    select distinct funding_agency_id ",
    "    from award_search ",
    "    where funding_agency_id is not null ",
    "    and certified_date >= '2007-10-01'::date ",
    "), ",
    "cited_agencies as ( ",
    "    select ",
    "        agency.id as agency_id, ",
    "        agency.toptier_flag, ",
    "        ta.toptier_agency_id, ",
    "        ta.toptier_code, ",
    "        ta.abbreviation as toptier_abbreviation, ",
    "        ta.name as toptier_name, ",
    "        sa.abbreviation as subtier_abbreviation, ",
    "        sa.name as subtier_name, ",
    "        sa.subtier_code, ",
    "        ( ",
    "            -- Subtier is cited as an awarding agency. ",
    "            exists ( ",
    "                select ",
    "                from ",
    "                awarding_agencies ",
    "                where awarding_agency_id = agency.id ",
    "            ) or ",
    "            -- Toptier has at least one subtier that is cited as an awarding agency. ",
    "            ( ",
    "                agency.toptier_flag is true and ",
    "                exists( ",
    "                    select ",
    "                    from ",
    "                    agency ag ",
    "                    inner join awarding_agencies ",
    "                        on ag.toptier_agency_id = agency.toptier_agency_id ",
    "                        and awarding_agencies.awarding_agency_id = ag.id ",
    "                ) ",
    "            ) ",
    "        ) as has_awarding_data, ",
    "        ( ",
    "            -- Subtier is cited as a funding agency. ",
    "            exists ( ",
    "                select ",
    "                from ",
    "                funding_agencies ",
    "                where funding_agency_id = agency.id ",
    "            ) or ",
    "            -- Toptier has at least one subtier that is cited as an funding agency. ",
    "            ( ",
    "                agency.toptier_flag is true and ",
    "                exists( ",
    "                    select ",
    "                    from ",
    "                    agency ag ",
    "                    inner join funding_agencies ",
    "                        on ag.toptier_agency_id = agency.toptier_agency_id ",
    "                        and funding_agencies.funding_agency_id = ag.id ",
    "                ) ",
    "            ) ",
    "        ) as has_funding_data ",
    "    from ",
    "        agency ",
    "        inner join toptier_agency as ta on ta.toptier_agency_id = agency.toptier_agency_id ",
    "        inner join subtier_agency as sa on sa.subtier_agency_id = agency.subtier_agency_id ",
    "    where ",
    "        -- As per PO guidance, do not include these two agencies. ",
    "        ta.toptier_code not in ('000', '067') ",
    ") ",
    "select ",
    "    dense_rank() over(order by toptier_code, ca.toptier_abbreviation, ca.toptier_name, ca.subtier_abbreviation, ca.subtier_name, ca.subtier_code, o.office_name, o.office_code) as agency_office_autocomplete_id, ",
    "    bool_or(ca.toptier_flag) as toptier_flag, ",
    "    ca.toptier_agency_id, ",
    "    ca.toptier_code, ",
    "    ca.toptier_abbreviation, ",
    "    ca.toptier_name, ",
    "    ca.subtier_abbreviation, ",
    "    ca.subtier_name, ",
    "    ca.subtier_code, ",
    "    bool_or(ca.has_awarding_data) as has_awarding_data, ",
    "    bool_or(ca.has_funding_data) as has_funding_data, ",
    "    o.office_code, ",
    "    o.office_name ",
    "from ",
    "    cited_agencies ca ",
    "left join office o ",
    "on ca.toptier_code = o.agency_code ",
    "   and ca.subtier_code = o.sub_tier_code",
    "where ",
    "    has_awarding_data is true or ",
    "    has_funding_data is true ",
    "group by ",
    "    toptier_agency_id, ",
    "    toptier_code, ",
    "    toptier_abbreviation, ",
    "    toptier_name, ",
    "    subtier_abbreviation, ",
    "    subtier_code, ",
    "    subtier_name, ",
    "    office_name, ",
    "    office_code "
  ],
  "indexes": [
    {
      "name": "agency_office_autocomplete_id",
      "unique": true,
      "columns": [{"name": "agency_office_autocomplete_id"}]
    }
  ]
}
