{
  "name": "universal_transaction_tableview",
  "clean_up": [
    "truncate table transaction_normalized_change_tracker;"
  ],
  "update_where": [
    "and tn.id in (select transaction_id from transaction_normalized_change_tracker)"
  ],
  "update": [
    "delete from",
    "",
    "    {table_name}",
    "",
    "where",
    "",
    "    transaction_id in (select transaction_id from transaction_normalized_change_tracker);",
    "",
    "",
    "insert into",
    "",
    "    {table_name}",
    "",
    "{select};"
  ],
  "create": [
    "create table",
    "",
    "    {table_name} as",
    "",
    "{select};"
  ],
  "select": [
    "select",
    "",
    "    to_tsvector(concat_ws(' ',",
    "        coalesce(rl.legal_business_name, fpds.awardee_or_recipient_legal, fabs.awardee_or_recipient_legal),",
    "        fpds.naics,",
    "        naics.description,",
    "        psc.description,",
    "        tn.description)",
    "    ) keyword_ts_vector,",
    "    to_tsvector(concat_ws(' ', a.piid, a.fain, a.uri)) award_ts_vector,",
    "    to_tsvector(coalesce(rl.legal_business_name, fpds.awardee_or_recipient_legal, fabs.awardee_or_recipient_legal)) recipient_name_ts_vector,",
    "",
    "    tn.id transaction_id,",
    "    tn.action_date::date,",
    "    tn.last_modified_date::date,",
    "    tn.fiscal_year,",
    "    tn.type,",
    "    tn.action_type,",
    "    tn.award_id,",
    "    a.category award_category,",
    "",
    "    coalesce(case",
    "        when tn.type in('07', '08') then tn.original_loan_subsidy_cost",
    "        else tn.federal_action_obligation",
    "    end, 0)::numeric(23, 2) generated_pragmatic_obligation,",
    "    a.total_obligation,",
    "    a.total_subsidy_cost,",
    "    a.total_loan_value,",
    "    obligation_to_enum(a.total_obligation) total_obl_bin,",
    "    a.fain,",
    "    a.uri,",
    "    a.piid,",
    "    coalesce(tn.federal_action_obligation, 0)::numeric(23, 2) federal_action_obligation,",
    "    coalesce(tn.original_loan_subsidy_cost, 0)::numeric(23, 2) original_loan_subsidy_cost,",
    "    coalesce(tn.face_value_loan_guarantee, 0)::numeric(23, 2) face_value_loan_guarantee,",
    "    tn.description transaction_description,",
    "    tn.modification_number,",
    "",
    "    coalesce(fpds.place_of_perform_country_n, fabs.place_of_perform_country_n) pop_country_name,",
    "    coalesce(fpds.place_of_perform_country_c, fabs.place_of_perform_country_c, 'USA') pop_country_code,",
    "    coalesce(fpds.place_of_performance_state, fabs.place_of_perfor_state_code) pop_state_code,",
    "    coalesce(fpds.place_of_perform_county_co, fabs.place_of_perform_county_co) pop_county_code,",
    "    coalesce(fpds.place_of_perform_county_na, fabs.place_of_perform_county_na) pop_county_name,",
    "    coalesce(fpds.place_of_performance_zip5, fabs.place_of_performance_zip5) pop_zip5,",
    "    coalesce(fpds.place_of_performance_congr, fabs.place_of_performance_congr) pop_congressional_code,",
    "    trim(trailing from coalesce(fpds.place_of_perform_city_name, fabs.place_of_performance_city)) pop_city_name,",
    "",
    "    case",
    "        when coalesce(fpds.legal_entity_country_code, fabs.legal_entity_country_code) = 'UNITED STATES' then 'USA'",
    "        else coalesce(fpds.legal_entity_country_code, fabs.legal_entity_country_code, 'USA')",
    "    end recipient_location_country_code,",
    "    coalesce(fpds.legal_entity_country_name, fabs.legal_entity_country_name) recipient_location_country_name,",
    "    coalesce(fpds.legal_entity_state_code, fabs.legal_entity_state_code) recipient_location_state_code,",
    "    coalesce(fpds.legal_entity_county_code, fabs.legal_entity_county_code) recipient_location_county_code,",
    "    coalesce(fpds.legal_entity_county_name, fabs.legal_entity_county_name) recipient_location_county_name,",
    "    coalesce(fpds.legal_entity_congressional, fabs.legal_entity_congressional) recipient_location_congressional_code,",
    "    coalesce(fpds.legal_entity_zip5, fabs.legal_entity_zip5) recipient_location_zip5,",
    "    trim(trailing from coalesce(fpds.legal_entity_city_name, fabs.legal_entity_city_name)) recipient_location_city_name,",
    "",
    "    fpds.naics naics_code,",
    "    naics.description naics_description,",
    "    fpds.product_or_service_code,",
    "    psc.description product_or_service_description,",
    "    fpds.pulled_from,",
    "    fpds.type_of_contract_pricing,",
    "    fpds.type_set_aside,",
    "    fpds.extent_competed,",
    "    fabs.cfda_number,",
    "    cfda.program_title cfda_title,",
    "",
    "    tn.recipient_id,",
    "    coalesce(rl.recipient_hash, md5(",
    "        upper(coalesce(fpds.awardee_or_recipient_legal, fabs.awardee_or_recipient_legal)))::uuid",
    "    )::uuid recipient_hash,",
    "    upper(coalesce(rl.legal_business_name, fpds.awardee_or_recipient_legal, fabs.awardee_or_recipient_legal)) recipient_name,",
    "    coalesce(fpds.awardee_or_recipient_uniqu, fabs.awardee_or_recipient_uniqu) recipient_unique_id,",
    "    coalesce(fpds.ultimate_parent_unique_ide, fabs.ultimate_parent_unique_ide) parent_recipient_unique_id,",
    "    le.business_categories,",
    "",
    "    tn.awarding_agency_id,",
    "    tn.funding_agency_id,",
    "    taa.name awarding_toptier_agency_name,",
    "    tfa.name funding_toptier_agency_name,",
    "    saa.name awarding_subtier_agency_name,",
    "    sfa.name funding_subtier_agency_name,",
    "    taa.abbreviation awarding_toptier_agency_abbreviation,",
    "    tfa.abbreviation funding_toptier_agency_abbreviation,",
    "    saa.abbreviation awarding_subtier_agency_abbreviation,",
    "    sfa.abbreviation funding_subtier_agency_abbreviation",
    "",
    "from",
    "",
    "    transaction_normalized tn",
    "    left outer join transaction_fabs fabs on tn.id = fabs.transaction_id",
    "    left outer join transaction_fpds fpds on tn.id = fpds.transaction_id",
    "    left outer join references_cfda cfda on fabs.cfda_number = cfda.program_number",
    "    left outer join legal_entity le on tn.recipient_id = le.legal_entity_id",
    "    left outer join recipient_lookup rl on rl.duns = coalesce(fpds.awardee_or_recipient_uniqu, fabs.awardee_or_recipient_uniqu)",
    "    left outer join awards a on tn.award_id = a.id",
    "    left outer join agency aa on tn.awarding_agency_id = aa.id",
    "    left outer join toptier_agency taa on aa.toptier_agency_id = taa.toptier_agency_id",
    "    left outer join subtier_agency saa on aa.subtier_agency_id = saa.subtier_agency_id",
    "    left outer join agency fa on tn.funding_agency_id = fa.id",
    "    left outer join toptier_agency tfa on fa.toptier_agency_id = tfa.toptier_agency_id",
    "    left outer join subtier_agency sfa on fa.subtier_agency_id = sfa.subtier_agency_id",
    "    left outer join naics on fpds.naics = naics.code",
    "    left outer join psc on fpds.product_or_service_code = psc.code",
    "",
    "where",
    "",
    "    tn.action_date >= '2000-10-01'::date {update_where}",
    "",
    "order by",
    "",
    "    tn.action_date"
  ],
  "indexes": [
    {
      "name": "transaction_id",
      "unique": true,
      "columns": [{"name": "transaction_id", "order": "asc nulls last"}]
    }, {
      "name": "action_date",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "action_date", "order": "desc nulls last"}]
    }, {
      "name": "last_modified_date",
      "columns": [{"name": "last_modified_date", "order": "desc nulls last"}]
    }, {
      "name": "fiscal_year",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "fiscal_year", "order": "desc nulls last"}]
    }, {
      "name": "type",
      "where": "type is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "type"}]
    }, {
      "name": "ordered_type",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "type", "order": "desc nulls last"}]
    }, {
      "name": "action_type",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "action_type"}]
    }, {
      "name": "award_id",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "award_id"}]
    }, {
      "name": "award_category",
      "where": "award_category is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "award_category"}]
    }, {
      "name": "total_obligation",
      "where": "total_obligation is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "total_obligation"}]
    }, {
      "name": "ordered_total_obligation",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "total_obligation", "order": "desc nulls last"}]
    }, {
      "name": "total_obl_bin",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "total_obl_bin"}]
    }, {
      "name": "total_subsidy_cost",
      "where": "total_subsidy_cost is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "total_subsidy_cost"}]
    }, {
      "name": "total_loan_value",
      "where": "total_loan_value is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "total_loan_value"}]
    }, {
      "name": "ordered_total_subsidy_cost",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "total_subsidy_cost", "order": "desc nulls last"}]
    }, {
      "name": "ordered_total_loan_value",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "total_loan_value", "order": "desc nulls last"}]
    }, {
      "name": "pop_country_code",
      "where": "pop_country_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_country_code"}]
    }, {
      "name": "pop_state_code",
      "where": "pop_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_state_code"}]
    }, {
      "name": "pop_county_code",
      "where": "pop_county_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_county_code"}]
    }, {
      "name": "pop_zip5",
      "where": "pop_zip5 is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_zip5"}]
    }, {
      "name": "pop_city_name",
      "where": "pop_city_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_city_name"}]
    }, {
      "name": "pop_congressional_code",
      "where": "pop_congressional_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_congressional_code"}]
    }, {
      "name": "gin_recipient_unique_id",
      "method": "gin",
      "columns": [{"name": "recipient_unique_id", "opclass": "gin_trgm_ops"}]
    }, {
      "name": "gin_parent_recipient_unique_id",
      "method": "gin",
      "columns": [{"name": "parent_recipient_unique_id", "opclass": "gin_trgm_ops"}]
    }, {
      "name": "recipient_id",
      "where": "recipient_id is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_id"}]
    }, {
      "name": "recipient_unique_id",
      "where": "recipient_unique_id is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_unique_id"}]
    }, {
      "name": "parent_recipient_unique_id",
      "where": "parent_recipient_unique_id is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "parent_recipient_unique_id"}]
    }, {
      "name": "awarding_agency_id",
      "where": "awarding_agency_id is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "awarding_agency_id", "order": "asc nulls last"}]
    }, {
      "name": "funding_agency_id",
      "where": "funding_agency_id is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "funding_agency_id", "order": "asc nulls last"}]
    }, {
      "name": "awarding_toptier_agency_name",
      "where": "awarding_toptier_agency_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "awarding_toptier_agency_name"}]
    }, {
      "name": "awarding_subtier_agency_name",
      "where": "awarding_subtier_agency_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "awarding_subtier_agency_name"}]
    }, {
      "name": "funding_toptier_agency_name",
      "where": "funding_toptier_agency_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "funding_toptier_agency_name"}]
    }, {
      "name": "funding_subtier_agency_name",
      "where": "funding_subtier_agency_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "funding_subtier_agency_name"}]
    }, {
      "name": "recipient_location_country_code",
      "where": "recipient_location_country_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_country_code"}]
    }, {
      "name": "recipient_location_state_code",
      "where": "recipient_location_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_state_code"}]
    }, {
      "name": "recipient_location_county_code",
      "where": "recipient_location_county_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_county_code"}]
    }, {
      "name": "recipient_location_zip5",
      "where": "recipient_location_zip5 is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_zip5"}]
    }, {
      "name": "recipient_location_congressional_code",
      "where": "recipient_location_congressional_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_congressional_code"}]
    }, {
      "name": "recipient_location_city_name",
      "where": "recipient_location_city_name is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_city_name"}]
    }, {
      "name": "cfda_multi",
      "where": "cfda_number is not null and action_date >= '2007-10-01'",
      "columns": [
        {"name": "cfda_number"},
        {"name": "cfda_title"}
      ]
    }, {
      "name": "pulled_from",
      "where": "pulled_from is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pulled_from"}]
    }, {
      "name": "type_of_contract_pricing",
      "where": "type_of_contract_pricing is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "type_of_contract_pricing"}]
    }, {
      "name": "extent_competed",
      "where": "extent_competed is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "extent_competed"}]
    }, {
      "name": "type_set_aside",
      "where": "type_set_aside is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "type_set_aside"}]
    }, {
      "name": "product_or_service_code",
      "where": "product_or_service_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "product_or_service_code"}]
    }, {
      "name": "gin_naics_code",
      "method": "gin",
      "columns": [{"name": "naics_code", "opclass": "gin_trgm_ops"}]
    }, {
      "name": "naics_code",
      "where": "naics_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "naics_code"}]
    }, {
      "name": "business_categories",
      "method": "gin",
      "columns": [{"name": "business_categories"}]
    }, {
      "name": "keyword_ts_vector",
      "method": "gin",
      "columns": [{"name": "keyword_ts_vector"}]
    }, {
      "name": "award_ts_vector",
      "method": "gin",
      "columns": [{"name": "award_ts_vector"}]
    }, {
      "name": "recipient_name_ts_vector",
      "method": "gin",
      "columns": [{"name": "recipient_name_ts_vector"}]
    }, {
      "name": "simple_pop_geolocation",
      "where": "pop_country_code = 'USA' and pop_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_state_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_pop_1",
      "where": "pop_country_code = 'USA' and pop_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_state_code"}, {"name": "pop_county_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_pop_2",
      "where": "pop_country_code = 'USA' and pop_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_state_code"}, {"name": "pop_congressional_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_pop_3",
      "where": "pop_country_code = 'USA' and pop_zip5 is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "pop_zip5"}, {"name": "action_date"}]
    }, {
      "name": "simple_recipient_location_geolocation",
      "where": "recipient_location_country_code = 'USA' and recipient_location_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_state_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_rl_1",
      "where": "recipient_location_country_code = 'USA' and recipient_location_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_state_code"}, {"name": "recipient_location_county_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_rl_2",
      "where": "recipient_location_country_code = 'USA' and recipient_location_state_code is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_state_code"}, {"name": "recipient_location_congressional_code"}, {"name": "action_date"}]
    }, {
      "name": "compound_geo_rl_3",
      "where": "recipient_location_country_code = 'USA' and recipient_location_zip5 is not null and action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_location_zip5"}, {"name": "action_date"}]
    }, {
      "name": "recipient_hash",
      "where": "action_date >= '2007-10-01'",
      "columns": [{"name": "recipient_hash"}]
    }, {
      "name": "type_pre2008",
      "where": "type is not null and action_date < '2007-10-01'",
      "columns": [{"name": "type"}]
    }, {
      "name": "pulled_from_pre2008",
      "where": "pulled_from is not null and action_date < '2007-10-01'",
      "columns": [{"name": "pulled_from"}]
    }, {
      "name": "recipient_location_country_code_pre2008",
      "where": "recipient_location_country_code is not null and action_date < '2007-10-01'",
      "columns": [{"name": "recipient_location_country_code"}]
    }, {
      "name": "recipient_location_state_code_pre2008",
      "where": "recipient_location_state_code is not null and action_date < '2007-10-01'",
      "columns": [{"name": "recipient_location_state_code"}]
    }, {
      "name": "action_date_pre2008",
      "where": "action_date < '2007-10-01'",
      "columns": [{"name": "action_date"}]
    }
  ]
}
